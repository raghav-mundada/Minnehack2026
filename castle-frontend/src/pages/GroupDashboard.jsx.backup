import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { getGroupStatus, getGroupStreak, getAppLimits, getAppUsage, createAppLimit, deleteAppLimit } from '../api/client';
import './GroupDashboard.css';

function GroupDashboard() {
  const { groupId } = useParams();
  const navigate = useNavigate();

  const [status, setStatus] = useState(null);
  const [streak, setStreak] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

 
  const [appLimits, setAppLimits] = useState([]);
  const [appUsage, setAppUsage] = useState([]);
  const [newAppName, setNewAppName] = useState('');
  const [newAppLimit, setNewAppLimit] = useState('');
  const [appLimitsLoading, setAppLimitsLoading] = useState(false);

  useEffect(() => {
    loadGroupData();
  }, [groupId]);

  const loadGroupData = async () => {
    setLoading(true);
    setError('');

    try {
      // Fetch status and streak in parallel
      const [statusData, streakData] = await Promise.all([
        getGroupStatus(groupId),
        getGroupStreak(groupId).catch(() => null), // Streak might fail, that's ok
      ]);

      setStatus(statusData);
      setStreak(streakData);
    } catch (err) {
      setError(err.message || 'Failed to load group data');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="container">
        <div className="loading">
          <div className="spinner"></div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container">
        <div className="page-header">
          <button
            className="back-button secondary"
            onClick={() => navigate('/')}
          >
            â† Back
          </button>
        </div>
        <div className="message error">{error}</div>
      </div>
    );
  }

  if (!status) {
    return (
      <div className="container">
        <div className="message error">Group not found</div>
      </div>
    );
  }

  const healthPercent = status.health_percent;
  // const healthPercent = 40; // TEMPORARY FOR TESTING
  const isAlive = status.alive;
  const usagePercent = Math.min(100, Math.round((status.used_minutes / status.limit_minutes) * 100));

  const getHealthColor = () => {
    if (healthPercent >= 70) return 'success';
    if (healthPercent >= 30) return 'warning';
    return 'danger';
  };

  const formatMinutes = (minutes) => {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    if (hours > 0) {
      return `${hours}h ${mins}m`;
    }
    return `${mins}m`;
  };

  const getUsageColor = (percent) => {
    // Smooth gradient from green â†’ yellow â†’ red
    // Green to Yellow (0% to 70%)
    if (percent <= 70) {
      const ratio = percent / 70;
      const red = Math.round(52 + (255 - 52) * ratio);
      const green = Math.round(199 - (199 - 149) * ratio);
      return `rgb(${red}, ${green}, 89)`;
    }
   
    else {
      const ratio = (percent - 70) / 30;
      const red = 255;
      const green = Math.round(149 - (149 - 59) * ratio);
      const blue = Math.round(0 + (48 - 0) * ratio);
      return `rgb(${red}, ${green}, ${blue})`;
    }
  };

  const getBackgroundClass = () => {
    if (healthPercent >= 70) return 'bg-sunny';
    if (healthPercent >= 30) return 'bg-sunset';
    return 'bg-stormy';
  };

  const getStatusText = () => {
    if (healthPercent >= 70) return 'Perfect Conditions â˜€ï¸';
    if (healthPercent >= 30) return 'Sunset Warning ğŸŒ…';
    return 'Storm Approaching â›ˆï¸';
  };

  return (
    <div className={`dashboard-container ${getBackgroundClass()}`}>

      {/* Navigation */}
      <div className="back-nav">
        <button className="back-button-glass" onClick={() => navigate('/')}>
          â† Back
        </button>
      </div>

    
      <header className="dashboard-header">
        <h1 className="group-title">{status.group_name || 'My Castle'}</h1>
        <div className="health-status-text">{getStatusText()}</div>
        <div className="date">{new Date(status.date).toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</div>
      </header>

     
      <div className="hero-castle-container">
        {/* Zombie Overlay */}
        {healthPercent < 50 && (
          <div className="zombie-horde">
            <div className="zombie left" style={{ animationDelay: '0s' }}>ğŸ§Ÿâ€â™‚ï¸</div>
            <div className="zombie left" style={{ animationDelay: '2s', bottom: '15%' }}>ğŸ§Ÿ</div>
            <div className="zombie right" style={{ animationDelay: '1s' }}>ğŸ§Ÿâ€â™‚ï¸</div>
            <div className="zombie right" style={{ animationDelay: '3s', bottom: '12%' }}>ğŸ§Ÿ</div>
            {healthPercent < 25 && (
              <>
                <div className="zombie left" style={{ animationDelay: '4s', bottom: '8%' }}>ğŸ§Ÿâ€â™‚ï¸</div>
                <div className="zombie right" style={{ animationDelay: '5s', bottom: '18%' }}>ğŸ§Ÿâ€â™‚ï¸</div>
              </>
            )}
          </div>
        )}

        <img
          className="hero-castle-img"
          src={`/assets/castle/castle_${healthPercent >= 87.5 ? '100' :
            healthPercent >= 62.5 ? '75' :
              healthPercent >= 37.5 ? '50' :
                healthPercent >= 12.5 ? '25' : '0'
            }.png`}
          alt="Castle"
        />

        {/* Floating Health Widget */}
        <div className="castle-health-overlay">
          <div className="big-health-number">{healthPercent}Â°</div>
          <div className="health-label">Health</div>
        </div>
      </div>

      {/* Stats Grid using Glassmorphism */}
      <div className="stats-grid">

        {/* Card 1: Daily Usage */}
        <div className="glass-card">
          <h3>Daily Usage</h3>
          <div className="stat-row">
            <span>Used: {formatMinutes(status.used_minutes)}</span>
            <span>Limit: {formatMinutes(status.limit_minutes)}</span>
          </div>
          <div className="glass-progress-track">
            <div
              className="glass-progress-fill"
              style={{ width: `${Math.min(100, usagePercent)}%` }}
            ></div>
          </div>
        </div>

        
        {streak && (
          <div className="glass-card" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
            <div>
              <h3>Streak</h3>
              <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>{streak.current_streak_days} Days ğŸ”¥</div>
            </div>
            <div style={{ fontSize: '0.9rem', opacity: 0.8, maxWidth: '150px', textAlign: 'right' }}>
              {streak.current_streak_days > 0 ? "Keep the flame alive!" : "Start a streak today!"}
            </div>
          </div>
        )}

      
        <div className="glass-card">
          <h3>Group Members</h3>
          <div className="members-list">
            {status.members && status.members.map((member, index) => (
              <div key={member.email} className="member-row-glass">
                <div className="rank-circle">{index + 1}</div>
                <div className="member-info-glass">
                  <div className="member-email-glass">{member.email.split('@')[0]}</div>
                  <div className="member-time-glass">{formatMinutes(member.total_minutes)}</div>
                </div>
                <button
                  className="nudge-btn-glass"
                  title="Nudge"
                  onClick={() => alert(`ğŸ”” Nudged ${member.email}!`)}
                >
                  ğŸ””
                </button>
              </div>
            ))}
          </div>
        </div>

        <button className="back-button-glass" style={{ width: '100%', marginTop: '1rem' }} onClick={loadGroupData}>
          ğŸ”„ Refresh Data
        </button>

      </div>
    </div>
  );
}

export default GroupDashboard;
